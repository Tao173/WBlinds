function x(b){return(...a)=>{var d={};a=b.call(d,...a);a=(new DOMParser).parseFromString(a,"text/html").getElementsByTagName("body").item(0).firstChild;d=d.init(a);d.node=a;return d}}stynj("#nav{background:rgba(0,0,0,.5);height:50px;display:flex;font-size:14px;justify-content:center}.navc{justify-content:space-around;align-self:center;max-width:500px}.navc .sel{color:#db8b1d}#nav>ul>li>.l{-webkit-margin-before:0;margin-block-start:0;-webkit-margin-after:0;margin-block-end:0;font-size:8px}");
const z=DOMTokenList.prototype;function A(b,...a){z.add.call(b.classList,...a)}function C(b,...a){z.remove.call(b.classList,...a)}
const F=setTimeout,I=document,J=window,K=I.createElement.bind(I),M=I.createElement.bind(I,"div"),N=I.getElementById.bind(I),aa=(b,a=I)=>a.getElementsByTagName.call(a,b),P=(b,a=I)=>a.querySelector.call(a,b),ba=b=>b.stopPropagation(),ca=(b,a)=>Q.call(b,a),Q=I.appendChild,R=b=>b&&"object"===typeof b&&!Array.isArray(b),T=(b,...a)=>{if(!a.length)return b;const d=a.shift();if(R(b)&&R(d))for(const f in d)R(d[f])?(b[f]||Object.assign(b,{[f]:{}}),T(b[f],d[f])):Object.assign(b,{[f]:d[f]});return T(b,...a)},
da=(b,a)=>Object.keys(a).reduce((d,f)=>{if(b[f]===a[f]||null==a[f])return d;if(R(b[f])&&R(a[f])){const h=da(b[f],a[f]);return 0===Object.keys(h).length?d:{...d,[f]:h}}return{...d,[f]:a[f]}},{}),ea=b=>new Promise(a=>{setTimeout(a,b)}),V=(...b)=>{console.debug.call(console,...b)},fa=b=>{const a={};for(const d in b)null!=b[d]&&(a[d]=b[d]);return a},ha=[],ia=b=>{const a=ha.push(b);return()=>{delete ha[a-1]}},ja=()=>{ha.forEach(b=>{b&&b()})};let ka=location.search;
const W=(b,a,d)=>{a=a||{};null==d&&(d=!0);const f=location.pathname,h=location.search;d=new URLSearchParams(d?"":h);for(const p in a)d.set(p,a[p]);a=d.toString();0<a.length&&(a="?"+a);b===f&&a===h?V("no change: ",b,f,a,h):(b=(b||f)+a,V("push history: ",b),history.pushState(null,"",b),a!==h&&ja())},la=x(function({labels:b}){let a=0,d=[];const f=[];this.init=h=>{const p=w=>{a=w;f.forEach((q,r)=>{r===a?A(q,"sel"):C(q,"sel")});d.map(q=>q(w))};b.map((w,q)=>{const r=K("li");A(r,"fC");q===a&&A(r,"sel");
var e=K("i");Q.call(e,w.i);Q.call(r,e);e=K("p");A(e,"l");e.innerText=w.t;Q.call(r,e);f.push(r);Q.call(h,r);r.onclick=()=>p(q)});return{onClick:w=>{d.push(w)},currentIndex:()=>a,destroy:()=>{d=[]},setIndex:p}};return'<ul class="fw navc"></ul>'});stynj(":root{--oc:#1d95db;--cc:#606060}.sc{pointer-events:none;padding:20px;align-self:center;align-items:center;justify-content:center;height:59%;overflow-x:hidden;width:50vh}.slider{pointer-events:all;transform:rotate(90deg);background:linear-gradient(90deg,var(--cc) 0,var(--cc) 50%,var(--oc) 0,var(--oc));height:7px;outline:none;border-radius:15px;height:150px;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:400px}.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:30px;transform:translateX(-15px);height:70px;background:transparent;border-right:2px solid #fff;box-shadow:#000;cursor:pointer}");
const X=(b,a,d,f,h,p)=>{a=(a-d)/(f-d)*100;b.style.background=`linear-gradient(to right, ${h} 0%, ${h} ${a}%, ${p} ${a}%, ${p} 100%`},ma=x(function({value:b}){let a=[];this.init=d=>{const f=P("input",d);f.onmousedown=f.ontouchstart=ba;const h=parseInt,p=h(f.min),w=h(f.max);f.oninput=()=>{const q=h(f.value);X(f,q,p,w,"#606060","#1d95db")};f.onchange=()=>{const q=h(f.value);a.forEach(r=>r(q))};f.value=`${b}`;X(f,b,p,w,"#606060","#1d95db");return{destroy:()=>{a=[]},onChange:q=>{a.push(q)}}};return'<div class="sc flex"><input class="slider" type="range" min="0" max="100"></div>'});
stynj('#card{position:fixed;top:100%;background:rgb(9 9 9/88%);border-radius:30px 30px 0 0;text-align:left;justify-content:center;font-size:12px}#card:after{content:"-";transform:scaleX(20) translate(.5px);position:fixed;color:var(--cc)}#card.an,#card>.an{transition:top .2s ease-in-out}.ca-con{width:80%;max-width:300px;padding-top:50px}.cR{margin-bottom:50px}#card .act{position:fixed;right:23px;top:100%;font-size:20px;font-weight:100;transform:scaleX(1.3)}');stynj(':root{--c:#1d95db}.in{justify-content:space-between;height:50px;align-items:center;background:rgba(0,0,0,.56);padding:0 0 0 15px;border-radius:15px;min-width:300px;font-size:14px}.in.disabled{color:grey}.in>label{font-weight:700}.igroup>.in{margin-top:0;border-radius:0;border-bottom:1px solid hsla(0,0%,100%,.30196078431372547)}.igroup>.in:first-child{border-radius:15px 15px 0 0;margin-top:20px}.igroup>.in:last-child{border-radius:0 0 15px 15px;margin-bottom:20px;border-bottom:none}.in-r{background:linear-gradient(90deg,var(--c) 0,var(--c) 50%,#606060 0,#606060);border-radius:8px;height:7px;width:75%;border-radius:15px;height:6px;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:100%;outline:none}.in-r::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:#fff;box-shadow:#000;border-radius:50%;cursor:pointer}.in>input:not([type=checkbox]),.in>select{flex-grow:1;padding:10px 27px 10px 0;background:transparent;border:none;color:#db8b1d;-moz-text-align-last:right;text-align-last:right;-webkit-appearance:none;-moz-appearance:none;text-align:right}.in>select+span{left:-10px;transform:scale(1.6,.9) translateY(-1px);font-weight:200;color:#db8b1d}.in>span{color:#5f5f5f;position:relative;font-size:12px;pointer-events:none;margin-left:-20px;left:-5px}.in>select{margin-inline:12px}.in:focus-within{box-shadow:inset -1px 0 rgba(219,139,29,.627)}.in>input:is([type=checkbox]){margin-right:15px}.in>input:disabled{color:grey}input::-webkit-inner-spin-button,input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}[type=checkbox]{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:51px;height:31px;border-radius:50px;background-color:rgba(148,148,154,.2)!important}[type=checkbox]:after{content:"";width:50%;border-radius:100%;height:80%;display:block;position:relative;background-color:#fff;top:12%;left:3%;transition:all .2s ease-in-out}[type=checkbox].on{background-color:#34c759!important}[type=checkbox].on:after{left:45%}');
const oa={[1]:"text",[2]:"checkbox",[0]:"number",[3]:"select",[4]:"password",[5]:"range"},pa=x(function({label:b,type:a,enumOpts:d,placeholder:f,value:h,unit:p,embed:w=!0,prevDefault:q=!1,min:r,max:e}){let k=h,g,t=[];const l=c=>{function n(u){""===u&&(u=void 0);k=u;t.forEach(B=>B(k))}c.innerHTML="";w&&A(c,"in");var y=K("label");y.innerText=b;Q.call(c,y);3===a?(g=K("select"),A(c,"in-s"),d.forEach(u=>{const B=K("option");B.value=u.v;B.innerText=u.l;Q.call(g,B)}),g.onchange=u=>{q&&u.preventDefault();
n(d[g.options.selectedIndex].v)}):(g=K("input"),g.type=oa[a],g.placeholder=f||"xxxxx",null!=r&&(g.min=`${r}`),null!=e&&(g.max=`${e}`),5===a&&A(g,"in-r"),2===a?((g.checked=h)&&A(g,"on"),g.onchange=u=>{q&&u.preventDefault();z.toggle.call(g.classList,"on");n(g.checked)}):g.onchange=u=>{q&&u.preventDefault();n(g.value)});null!=h&&(g.value=h);g.id=y.htmlFor=`in-${b.split(" ").join("-")}`;Q.call(c,g);if(3===a||p)y=K("span"),y.innerText=p?p:"v",Q.call(c,y)};this.init=c=>{l(c);return{onChange:n=>{t.push(n)},
setDisabled:n=>{z.toggle.call(c.classList,"disabled");g.disabled=n},destroy:()=>{t=[]},reset:()=>{l(c)},isDirty:()=>h!==k}};return'<div class="fR"></div>'}),qa=["Speed","Acceleration"],ra=[[1,5E3],[1,4294967294]],sa=x(function({pos:b,accel:a,speed:d,...f}){let h=[],p=!1,w=0,q=0,r=!1,e={},k=[];this.init=g=>{function t(m){null==m&&(m=!1);m!==r&&(m?A(g,"an"):C(g,"an"),m?A(c,"an"):C(c,"an"),r=m)}const l=P(".ca-con",g),c=P(".act",g);t(!0);V("card data: ",f);const n=m=>{h.forEach(D=>D(m))},y=m=>{const D=
0===m?d:a,H=pa({type:5,label:qa[m],value:D,embed:!1,min:ra[m][0],max:ra[m][1]}),G=P("input",H.node);C(H.node,"fR");A(H.node,"cR");const L=parseInt,O=L(G.min),Y=L(G.max);G.oninput=()=>{const S=L(G.value);X(G,S,O,Y,"#1d95db","#606060")};H.onChange(S=>{0===m?n({speed:S,...f}):1===m&&n({accel:S,...f})});Q.call(l,H.node);X(G,D,O,Y,"#1d95db","#606060");k.push(H)};y(0);y(1);const u=ma({value:b});u.onChange(m=>{n({tPos:m,...f})});Q.call(l,u.node);const B=()=>{t(!0);g.ontransitionend=E;const m=g.clientHeight;
g.style.top=`${m}px`;c.style.top=`${m+12}px`};c.onclick=B;const E=()=>{h=[];u.destroy();k.forEach(m=>m.destroy());k=[];g.remove()},v=m=>{let {x:D,y:H}=m;null==D&&(D=m.touches[0].clientX,H=m.touches[0].clientY);return{x:D,y:H}};g.onmousedown=g.ontouchstart=m=>{e=m=v(m);q=m.y;p=!0;t(!1)};g.onmouseup=g.onmouseout=g.ontouchend=()=>{if(p){p=!1;t(!0);if(w>g.clientHeight/2)return B();g.style.top="8px";c.style.top="20px";w=q=8}};g.onmousemove=g.ontouchmove=m=>{m=v(m);p&&(8>m.y-q?e=m:(w+=m.y-e.y,e=m,g.style.top=
`${w}px`,c.style.top=`${w+12}px`))};return{destroy:E,onChange:m=>{h.push(m)},show:()=>{g.style.top="8px";c.style.top="20px"}}};return'<div id="card" class="an f flex"><div class="ca-con flex fC"></div><div class="act">X</div></div>'});stynj(":root{--wid:min(calc(33.3vw - 20px),110px,110px)}.tile{background:rgba(0,0,0,.3);border-radius:12px;display:flex}.tile.sq{width:var(--wid);height:var(--wid);margin:5px 0;position:relative}.tile.sq>span{width:calc(var(--wid) - 1px);max-height:90px;top:10px;position:absolute;right:0;border-right:1px groove #fff}.tile.sq p{font-size:11px;margin:auto 21px 10px 9px;font-weight:500}");
const ta=x(function({name:b,id:a,...d}){let f=[];this.init=h=>{h.id=a;h.onclick=()=>{f.forEach(p=>p({id:a,name:b,...d}))};P("p",h).innerText=b;return{onClick:p=>{f.push(p)},destroy:()=>{f=[]}}};return'<div class="tile sq"><span></span><p>Bedroom Left</p></div>'});stynj(':root{--bord:1px solid rgba(0,0,0,0.034)}#pas{border-radius:7px;justify-content:center;max-width:400px;border:transparent;background:rgba(118,118,128,.24);margin:auto}#pas>div{padding:2px 0;flex-grow:1;text-align:center;font-size:14px;border:1px transparent}#pas>div.sel{background-color:rgba(103,103,105,.64);border-radius:7px;border:1px solid rgba(0,0,0,.14)}#pas>div:after{height:13px;content:"";display:block;position:absolute;border-left:1px solid rgba(142,142,147,.45);border-radius:.5px;transform:translate(-1px,-110%)}#pas>div:first-child:after{border-left:none}');
const ua=x(function({items:b,queries:a}){let d=0,f=[],h=[];this.init=p=>{const w=()=>{if(!(1>a.length)){a:{var e=location.search;e=e.substring(1).split("&");for(let k=0;k<e.length;k++){const g=e[k].split("=");if("tab"==g[0]){e=g[1];break a}}e=!1}e=e&&e.toLowerCase();e=a.indexOf(e);V("handleQueryChange: ",e);0>e&&(e=0);d!==e&&r(e)}},q=ia(w),r=e=>{C(h[d],"sel");d=e;A(h[d],"sel");f.map(k=>k(e))};b.map((e,k)=>{const g=M();g.innerText=e;k===d&&A(g,"sel");g.onclick=()=>{a[k]&&W(void 0,{tab:a[k]});r(k)};
h.push(g);Q.call(p,g)});w();return{destroy:()=>{q();f=[];d=0;h=[]},index:()=>d,onChange:e=>{f.push(e)},setIndex:e=>{a[e]&&W(void 0,{tab:a[e]});r(e)}}};return'<div id="pas" class="fw flex fR"></div>'});stynj(".toast{background-color:rgba(0,0,0,.44);box-shadow:1px 1px 8px rgba(84,84,84,.451);border-radius:10px;font-size:13px;margin:10px;height:60px;display:flex;min-width:250px;max-width:500px;position:relative;transition:bottom .5s ease-in-out;pointer-events:all;align-self:center}.tom{margin:auto}");
const va=x(function({message:b,id:a}){let d=[];this.init=f=>{f.onclick=()=>{d.forEach(h=>h({id:a}))};P("p",f).innerText=b;return{onClick:h=>{d.push(h)},destroy:()=>{d=[]}}};return'<div class="toast"><p class="tom"></p></div>'});stynj(".tc{display:flex;position:absolute;top:0;flex-flow:column-reverse;pointer-events:none;height:calc(100% - 50px);padding-bottom:50px}");
const wa=x(function(){let b=0,a=[];this.init=d=>({destroy:()=>{a.map(f=>f.destroy());a=[];b=0},pushToast:(f,h,p,w)=>{h&&console.error(f);const q=()=>{e.node.style.bottom=`-${50+200*(a.length+1)}px`},r=()=>{q();setTimeout(()=>{e.node.remove()},500)},e=va({message:f,isError:h,id:b++});q();e.onClick(r);a.push(e);Q.call(d,e.node);setTimeout(()=>{e.node.style.bottom="0px";!p&&setTimeout(r,w||h?5E3:2500)})}});return'<div id="toc" class="fw tc"></div>'}),xa={gen:{deviceName:"WBlinds",mdnsName:"WBlinds",
emitSync:!1},hw:{pStep:19,pDir:18,pEn:13,pSleep:21,pReset:3,pMs1:1,pMs2:5,pMs3:17,pHome:4,cLen:1650,cDia:.1,axDia:15,stepsPerRev:200,res:16},mqtt:{enabled:!1,host:"192.168.0.99",port:1833,topic:"wblinds",user:"user"}},ya={state:{pos:0,tPos:0,accel:0,speed:0},settings:T({},xa),pendingState:T({},xa),devices:{},presets:{}};
class za{constructor(){this._observers={};this._state=T({},ya);const b={};Object.keys(this._state).map(a=>{b[a]=!1});this._loadedKeys={...b};this._savingKeys={...b}}get(b){b=b.split(".");let a=this._state;for(;0<b.length;){if("object"!==typeof a)return;a=a[b.shift()]}return a}set(b,a){b=b.split(".");const d=b.pop();let f=this._state;for(;0<b.length;){if("object"!==typeof f)return;f=f[b.shift()]}f[d]=a}isLoaded(b){return this._loadedKeys[b]}setSaving(b,a){this._savingKeys[b]=a}isSaving(b){return this._savingKeys[b]}update(b,
a){this._observers[b]=this._observers[b]||[];const d=this._state[b];this._state[b]=T({},d,fa(a));this._loadedKeys[b]=!0;this._observers[b].forEach(f=>{f({value:{...a},prev:d})})}observe(b,a){this._observers[b]=this._observers[b]||[];this._observers[b].push(a);this._loadedKeys[b]&&a({value:T({},this._state[b]),prev:void 0})}}const Z=new za;stynj(".dt{justify-content:space-between}.pt>.sq{height:50px;width:auto;min-width:150px}.pt>.sq>span{display:none}");
const Aa=x(function(){let b=!0,a=[],d=[],f;this.init=()=>{const h=()=>{if(b){var e=N("hl"),k=N("hlc");e.style.display="none";C(k,"hide");b=!1}},p=e=>{e=N(`${e}-tiles`);return{container:e,tiles:e.querySelectorAll("div")}},w=e=>{const {container:k,tiles:g}=p(e);e=Math.floor(k.clientWidth/110);let t=g.length;for(;0!==t%e;){const l=M();A(l,"tile","sq","em");Q.call(k,l);t++}},q=(e,k)=>{"device"===e&&d.forEach(g=>g(k))},r=(e,k)=>{const {container:g,tiles:t}=p(e);t.forEach(l=>{const {id:c}=l;c.endsWith(f)||
c in k?k[c]=void 0:l.remove()});for(const [l,c]of Object.entries(k)){if(!c)continue;const n=ta({id:`tile-${l}`,name:c.name||l,...c});n.onClick(y=>q(e,y));a.push(n);Q.call(g,n.node)}w(e)};F(()=>{Z.observe("presets",({value:e,prev:k})=>{V("presets updated: ",e,k);h();r("preset",e)});Z.observe("state",({value:e,prev:k})=>{V("state updated: ",e,k);f=Z.get("settings.gen.deviceName");h();k=Z.get("settings.gen");const g=Z.get("state");V("set tile: ",k.deviceName,{...k,...e,...g});r("device",{[k.deviceName]:{...k,
...e,...g}})});Z.observe("devices",({value:e,prev:k})=>{V("devices updated: ",e,k);h();r("device",e)})});return{onDeviceClick:e=>{d.push(e)},destroy:()=>{d=[];a.forEach(e=>e.destroy());a=[]}}};return'<div id="h" class="f flex"><div id="hl" class="loader"></div><div id="hlc" class="hide fw" style="text-align: left;"><h1 id="ht">WBlinds</h1>\x3c!-- <h4 class="hst">Presets</h4> --\x3e<div id="preset-tiles" class="pt fw flex wrap"></div><h4 class="hst">Devices</h4><div id="device-tiles" class="dt fw flex wrap"></div></div></div>'});
stynj("#stcc{display:flex}#stcc>span{margin:auto}#stcc>span:last-child{margin-bottom:70px}#stcc>div{justify-content:center}#slc-act{position:fixed;bottom:55px;justify-content:space-evenly;left:0}");stynj(".calib-btn{margin-top:40px}#calib-c,#calib-x{position:fixed;left:100%;transition:left .4s ease-in-out;top:0}#calib-c{background:url(https://github.com/maxakuru/WBlinds/blob/main/public/bg.jpg?raw=true),#000;background-position:50%;background-size:cover;overflow:hidden}#calib-c>div{width:100vw;height:100vh}#calib-c>div>h2{margin:80px 30px 10px}#calib-c>div>p{font-size:13px;margin:5px 30px 10px}#calib-x{margin:10px;width:90px;transition-delay:0s;transition-duration:.4s}.cal-conc{margin:20px auto;max-width:300px;display:flex;flex-wrap:wrap}");
const Ba=[{t:"Find home position",d:"Move to the fully open position then tap 'Done'. \nBe careful not to wind the cord too tight."},{t:"Find closed position",d:"Move to the fully closed position then tap 'Done'"},{o:!0,t:"Repeat",d:"Alternate between open and closed, tap the corresponding button in between. Repeat as many times as you like. \n\nDue to the differences in how the cord may wrap around the axis, this may or may not be needed."}],Ca=x(function(){let b,a,d=!1,f=[],h,p=0;const w=window.wblinds.tc,
q=(k,g,t)=>{var l=K("div");A(l,"fC");var c=K("h2");c.innerText=`${g+1}. ${k.t}`;Q.call(l,c);c=K("p");c.innerText=`${k.d}`;Q.call(l,c);var n=K("div");n.style.height="90%";A(n,"fC");Q.call(l,n);c=K("div");A(c,"fR");Q.call(l,c);const y={div:l,c:n};l=E=>async()=>{const v=E?"preNext":"preBack";try{y[v]&&await y[v]()}catch(m){w.pushToast(`"[Calib] Error in pre: ${m}"`)}p+=E?1:-1;h.style.left=`-${J.innerWidth*p}px`};0<g&&(n=K("button"),n.innerText="Back",Q.call(c,n),n.onclick=l(!1));const u=K("button"),
B=g===t-1?"Done":"Next";k.o||(u.disabled=!0);y.showNext=E=>{E?(u.innerText="",E=K("div"),A(E,"loader"),Q.call(u,E)):(u.innerText=B,u.disabled=!1)};u.innerText=B;u.onclick=l(!0);Q.call(c,u);return y},r=()=>{const k=K("div");A(k,"cal-conc");["speed \u25b2","move \u25b2","speed \u25bc","move \u25bc"].forEach(g=>{const t=K("button");t.innerText=g;-1<g.indexOf("up")?A(t,"btn-up"):A(t,"btn-down");Q.call(k,t)});return k},e=()=>{Ba.forEach((k,g)=>{const t=q(k,g,Ba.length);k=r();Q.call(t.c,k);k=K("button");
k.innerText="Done";Q.call(t.c,k);k.onclick=async()=>{t.showNext(!0);setTimeout(()=>{t.showNext()},4E3)};Q.call(h,t.div)});h.style.width=`${J.innerWidth*Ba.length}px`;h.style.left="0";b.style.left="0"};this.init=k=>{h=P("div",k);const g=aa("button",k);a=g.item(0);b=g.item(1);a.onclick=()=>{d||(d=!0,C(b,"hide"),C(h,"hide"),F(e))};b.onclick=()=>{const t=.2*(p+1);h.style.transitionDuration=`${t}s`;b.style.transitionDelay=`${.2*(p-.5)}s`;b.style.transitionDuration="0.2s";h.style.left=`${J.innerWidth}px`;
b.style.left=`${J.innerWidth}px`;setTimeout(()=>{p=0;h.style.transitionDuration="0.4s";b.style.transitionDuration="0.4s";b.style.transitionDelay="0s";h.innerHTML="";A(h,"hide");d=!1},1E3*t)};return{destroy:()=>{f=[];k.remove()},setDisabled:t=>{a.disabled=t},onSave:t=>{f.push(t)}}};return'<div class="f fC"><button class="calib-btn">Calibrate</button><div id="calib-c" class="hide fR"></div><button id="calib-x" class="btn-t hide">&lt; cancel</button></div>'}),Da={gen:{ssid:{t:1,l:"SSID",g:0},pass:{t:4,
l:"Password",g:0},deviceName:{t:1,l:"Device name",g:0},mdnsName:{t:1,l:"mDNS Name",g:0},emitSync:{t:2,l:"Emit sync data"}},hw:{axDia:{l:"Axis diameter",g:2,u:"mm"},cDia:{l:"Cord diameter",g:2,u:"mm"},cLen:{l:"Cord length",g:2,u:"mm"},pDir:{l:"Direction pin",g:1},pEn:{l:"Enable pin",g:1},pHome:{l:"Home switch pin",g:1},pMs1:{l:"Microstep pin 1",g:1},pMs2:{l:"Microstep pin 2",g:1},pMs3:{l:"Microstep pin 3",g:1},pReset:{l:"Reset pin",g:1},pSleep:{l:"Sleep pin",g:1},pStep:{l:"Step pin",g:1},stepsPerRev:{l:"Steps/revolution",
g:2},res:{t:3,l:"Resolution",g:2,o:[{l:"1",v:1},{l:"1/2",v:2},{l:"1/4",v:4},{l:"1/8",v:8},{l:"1/16",v:16}]}},mqtt:{enabled:{t:2,l:"Enabled",g:3,cg:!0},host:{t:1,l:"Host",g:3},port:{l:"Port",g:3},topic:{t:1,l:"Topic",g:3},user:{t:1,l:"Username",g:3},pass:{t:4,l:"Password",g:3}}},Ea=x(function(){let b=!0,a=!1,d=!1,f=[],h=[],p=[];const w=[],q=["General","Hardware","MQTT"],r=Object.keys(Da);let e,k,g,t,l;this.init=()=>{const n=ua({items:q,queries:r}),y=v=>{const m=N("stcc");if(m){var D;0===v?D=e:1===
v?D=k:2===v&&(D=g);m.innerHTML="";Q.call(m,D)}else t=()=>y(v)};n.onChange(y);const u=()=>{V("settings loaded: ",Z._state);if(b||a)if(b||!Z.isSaving("settings")){var v=N("sl"),m=N("slc");v.style.display="none";C(m,"hide");m.prepend(n.node);b=!1;a&&B(!1);v=N("stcc");v||(v=M(),v.id="stcc",Q.call(m,v));e=E(r[0]);l=Ca();Q.call(e,l.node);k=E(r[1]);g=E(r[2]);if(!t)return n.setIndex(n.index());t();t=void 0}};F(()=>{Z.observe("settings",({value:v,prev:m})=>{V("settings updated: ",v,m);u()})});const B=v=>{v!==
d&&(a=!1,d=v,l&&l.setDisabled(d),v=N("slc-act"),d?(N("s-save").onclick=()=>{a=!0;f.map(m=>m())},N("s-can").onclick=()=>{a=!0;h.map(m=>m());u()},C(v,"hide")):A(v,"hide"))},E=v=>{const m=K("span"),D=[],H=(G,L)=>{if(null==G)return Q.call(m,L.node);if(null==D[G]){const O=M();A(O,"igroup");D[G]=[O,[]];Q.call(m,O)}D[G][1].push(L);Q.call(D[G][0],L.node)};for(const G in Da[v]){const {g:L,cg:O,l:Y,t:S=0,o:Ia,u:Ja}=Da[v][G],Ka=`${"pendingState"}.${v}.${G}`,U=pa({label:Y,type:S,enumOpts:Ia,value:Z.get(`${"settings"}.${v}.${G}`),
unit:Ja});H(L,U);const La=p.push(U);U.onChange(na=>{O&&c(na,U,D[L][0],D[L][1]);w[La]=U.isDirty();B(0<w.filter(Ma=>!0===Ma).length);Z.set(Ka,na)})}return m};return{destroy:()=>{n.destroy();p.forEach(v=>v.destroy());p=[];f=[];h=[]},onCancel:v=>{h.push(v)},onSave:v=>{f.push(v)}}};const c=(n,y,u,B)=>{n?C(u,"disabled"):A(u,"disabled");B.forEach(E=>{y!==E&&E.setDisabled(!n)})};return'<div id="ps" class="f fC"><div id="sl" class="loader"></div><div id="slc" class="hide fw" style="text-align: left;"><div id="slc-act" class="fR fw hide"><button id="s-can" class="btn-c">Cancel</button> <button id="s-save" class="btn-s">Save</button></div></div></div>'}),
Ga=(b,a,d)=>Fa(b,a,d),Fa=(b,a,d,f)=>{f=f||0;d=d||{};a=a||"GET";const h=R(d.body)?JSON.stringify(d.body):d.body,p={...(d.headers||{})};h&&(p["content-type"]="application/json");const w=`${"/api"}/${b}`;return fetch(w,{body:h,method:a,headers:p}).then(q=>{V("got res: ",q);if(!q.ok){f+=1;if(8<f||500>q.status){const r=Error(`[${a}] ${w} failed (${q.status})`);r.response=q;throw r;}return ea(5E3*f).then(()=>Fa(b,a,d,f))}return"GET"===a?q.json():void 0})},Ha=[4,5,22,24],Na="pos tPos speed accel deviceName mdnsName emitSyncData pinStep pinDir pinEn pinSleep pinReset pinMs1 pinMs2 pinMs3 pinHomeSw cordLength cordDiameter axisDiameter stepsPerRev resolution mqttEnabled mqttHost mqttPort mqttTopic moveUp moveDown moveStop tick".split(" "),
Oa=(b={})=>{let a,d=!1,f=0;const {onMessage:h,onDisconnect:p,onConnect:w,onError:q}=b,r=!!q,e=!!w,k=!!h,g=!!p,t=()=>{a=new WebSocket(`ws://${location.hostname}/ws`);a.onopen=l=>{V("[ws] onOpen(): ",l);d=!0;f=0;e&&w(l,f)};a.onclose=l=>{V("[ws] onClose(): ",l);d=!1;g&&p(l,f);setTimeout(t,Math.min(5E3*++f,6E4))};a.onmessage=l=>{V("[ws] onMessage(): ",l,l.data);l=l.data;V("unpackMessages: ",l);var c=l.split("/");let [n,y,u]=c;parseInt(y);u=parseInt(u);u.toString(2).split("1").length-1!==c.length-4&&r&&
q("Event flags and data don't match",0);l={};const B={};let E=1;for(let v=3,m=Na.length;v<m&&0<c.length;v++){if(E&u){const D=Na[v],H=c.shift();4>v?l[D]=parseInt(H):B[D]=v in Ha?H:parseInt(H)}E<<=1}c=[];0<Object.keys(l).length&&c.push({type:0,mac:n,data:l});0<Object.keys(B).length&&c.push({type:1,mac:n,data:B});k&&c.forEach(h)};a.onerror=l=>{V("[ws] onError(): ",l);d=!1;r&&q(l,f)}};t();return{ws:a,push:(l,c)=>{V("[ws] push(): ",l,c);if(d){var n=c.mac;var y=0===l?[c.pos,c.tPos,c.speed,c.accel]:2===
l?[c.moveBy,c.stop]:[];a:{switch(l){case 0:const B=[];c="";for(var u in y){const E=y[u];null!=E?(c+=`${E}/`,B.push(1)):B.push(0)}V("[packMessage] f: ",B);u=parseInt(B.reverse().join(""),2);l=`${n}/${l}/${u}/${c}`;break a;default:r?q("Unexpected event type",0):console.error("Unexpected event type")}l=void 0}V("[ws] push() str: ",l);a.send(l)}}}},Pa=b=>{const a=document.createElementNS("http://www.w3.org/2000/svg","svg"),d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("fill",
"currentColor");d.setAttribute("d",b.data);a.setAttribute("viewBox",b.box);Q.call(a,d);a.style.width=`${b.w}px`;return a},Qa=Pa({data:"M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z",
box:"0 0 576 512",w:22}),Ra=Pa({data:"M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z",box:"0 0 512 512",w:20}),Sa=Pa({data:"M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z",
box:"0 0 512 512",w:20}),Ta=[{t:"Home",i:Qa},{t:"Routines",i:Ra},{t:"Settings",i:Sa}];
export var run=b=>{function a(){V("saveSettings: ",Z._state);Z.setSaving("settings",!0);V("State._state.settings: ",Z._state.settings);V("State._state.pendingState: ",Z._state.pendingState);const c=da(Z._state.settings,Z._state.pendingState);V("diffed: ",c);Ga("settings","PUT",{body:c}).then(()=>{Z.setSaving("settings",!1);var n=Z.update,y=Z._state.pendingState;y?.gen?.pass&&(y.gen.pass=void 0);y?.mqtt?.pass&&(y.mqtt.pass=void 0);n.call(Z,"settings",y);k.pushToast("Settings saved")}).catch(n=>{k.pushToast("Failed to save settings");
throw n;})}function d(){V("cancelSettings: ",Z._state);Z.update("pendingState",Z._state.settings)}function f(c){c=sa(c);Q.call(w,c.node);c.onChange(n=>{g.push(0,n)});setTimeout(c.show)}function h(c,n,y=[]){n=n||[c];return Fa(c,void 0,void 0).then(u=>{n.forEach(B=>Z.update(B,u));y.forEach(B=>Z.set(B,u));return u}).catch(p)}function p(c){c=R(c)?(c?.message||"Error encountered, check console")+"\n"+c.stack:c;k.pushToast(c,!0)}V("onLoad(): ",b);const w=P("body"),q=N("app");let r=-1,e;b.state=Z;const k=
wa();b.tc=k;Q.call(w,k.node);J.onerror=p;J.onpopstate=()=>{l(location.pathname);{const c=location.search;V("q === query: ",c,ka,location.search);c!==ka&&(ka=c,ja())}};const g=Oa({onMessage(c){V("WS msg: ",c);1===c.type&&Z.update("settings",{...Z.get("settings"),...c.data})},onError(c,n){n||k.pushToast("Websocket disconnected!",!0,!1,5E3)},onConnect(c,n){V("WS connect: ",c);n&&k.pushToast("Websocket connected!")},onDisconnect(c){V("WS disconnect: ",c)}}),t=la({labels:Ta});ca(N("nav"),t.node);t.onClick(function(c){if(r!==
c){var n=`/${Ta[c].t.toLowerCase()}`;r=c;e?.destroy?.();e?.node.remove();switch(c){case 0:c=Aa();W(n,void 0,!0);c.onDeviceClick(f);Z.isLoaded("state")||h("settings?type=gen",[],["settings.gen"]).then(()=>{h("state");h("presets");h("devices")});e=c;break;case 1:W(n,void 0,!0);e=null;break;case 2:c=Ea(),W(n,void 0,!1),c.onSave(a),c.onCancel(d),e=c,Z.isLoaded("settings")||h("settings",["pendingState","settings"])}e&&Q.call(q,e.node)}});const l=c=>{c=Ta.map(n=>n.t.toLowerCase()).indexOf(c.substr(1));
0>c&&(c=0);t.setIndex(c)};l(location.pathname)};
