function u(b){return(...a)=>{var d={};a=b.call(d,...a);a=(new DOMParser).parseFromString(a,"text/html").getElementsByTagName("body").item(0).firstChild;d=d.init(a);d.node=a;return d}}stynj("#nav{background:rgba(0,0,0,.5);height:50px;display:flex;font-size:10px;justify-content:center}.navc{justify-content:space-around;align-self:center;max-width:500px}.navc .sel{color:#db8b1d}#nav>ul>li>.l{-webkit-margin-before:0;margin-block-start:0;-webkit-margin-after:0;margin-block-end:0}");
const B=DOMTokenList.prototype;function C(b,...a){B.add.call(b.classList,...a)}function D(b,...a){B.remove.call(b.classList,...a)}
const aa=setTimeout,E=document,I=window,J=E.createElement.bind(E),K=E.createElement.bind(E,"div"),N=E.getElementById.bind(E),ba=(b,a=E)=>a.getElementsByTagName.call(a,b),O=(b,a=E)=>a.querySelector.call(a,b),ca=b=>b.stopPropagation(),da=(b,a)=>Q.call(b,a),Q=E.appendChild,R=b=>b&&"object"===typeof b&&!Array.isArray(b),S=(b,...a)=>{if(!a.length)return b;const d=a.shift();if(R(b)&&R(d))for(const e in d)R(d[e])?(b[e]||Object.assign(b,{[e]:{}}),S(b[e],d[e])):Object.assign(b,{[e]:d[e]});return S(b,...a)},
ea=(b,a)=>Object.keys(a).reduce((d,e)=>{if(b[e]===a[e]||null==a[e])return d;if(R(b[e])&&R(a[e])){const m=ea(b[e],a[e]);return 0===Object.keys(m).length?d:{...d,[e]:m}}return{...d,[e]:a[e]}},{}),fa=b=>new Promise(a=>{setTimeout(a,b)}),U=(...b)=>{console.debug.call(console,...b)},ha=b=>{const a={};for(const d in b)null!=b[d]&&(a[d]=b[d]);return a},ia=[],ja=b=>{const a=ia.push(b);return()=>{delete ia[a-1]}},ka=()=>{ia.forEach(b=>{b&&b()})};let la=location.search;
const V=(b,a,d)=>{a=a||{};null==d&&(d=!0);const e=location.pathname,m=location.search;d=new URLSearchParams(d?"":m);for(const r in a)d.set(r,a[r]);a=d.toString();0<a.length&&(a="?"+a);b===e&&a===m?U("no change: ",b,e,a,m):(b=(b||e)+a,U("push history: ",b),history.pushState(null,"",b),a!==m&&ka())},ma=u(function({labels:b}){let a=0,d=[];const e=[];this.init=m=>{const r=v=>{a=v;e.forEach((t,x)=>{x===a?C(t,"sel"):D(t,"sel")});d.map(t=>t(v))};b.map((v,t)=>{const x=J("li");C(x,"fC");t===a&&C(x,"sel");
var n=J("i");Q.call(n,v.i);Q.call(x,n);n=J("p");C(n,"l");n.innerText=v.t;Q.call(x,n);e.push(x);Q.call(m,x);x.onclick=()=>r(t)});return{onClick:v=>{d.push(v)},currentIndex:()=>a,destroy:()=>{d=[]},setIndex:r}};return'<ul class="fw navc"></ul>'});stynj(":root{--oc:#1d95db;--cc:#606060}.sc{pointer-events:none;padding:20px;align-self:center;align-items:center;justify-content:center;height:59%;overflow-x:hidden;width:50vh}.slider{pointer-events:all;transform:rotate(90deg);background:linear-gradient(90deg,var(--cc) 0,var(--cc) 50%,var(--oc) 0,var(--oc));height:7px;outline:none;border-radius:15px;height:150px;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:400px}.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:30px;transform:translateX(-15px);height:70px;background:transparent;border-right:2px solid #fff;box-shadow:#000;cursor:pointer}");
const X=(b,a,d,e,m,r)=>{a=(a-d)/(e-d)*100;b.style.background=`linear-gradient(to right, ${m} 0%, ${m} ${a}%, ${r} ${a}%, ${r} 100%`},oa=u(function({value:b}){let a=[];this.init=d=>{const e=O("input",d);e.onmousedown=e.ontouchstart=ca;const m=parseInt,r=m(e.min),v=m(e.max);e.oninput=()=>{const t=m(e.value);console.log("slider on input: ",t);X(e,t,r,v,"#606060","#1d95db")};e.onchange=()=>{const t=m(e.value);console.log("slider on change: ",t);a.forEach(x=>x(t))};e.value=`${b}`;X(e,b,r,v,"#606060","#1d95db");
return{destroy:()=>{a=[]},onChange:t=>{a.push(t)}}};return'<div class="sc flex"><input class="slider" type="range" min="0" max="100"></div>'});stynj('#card{position:fixed;top:100%;background:rgb(9 9 9/88%);border-radius:30px 30px 0 0;text-align:left;justify-content:center;font-size:12px}#card:after{content:"-";transform:scaleX(20) translate(.5px);position:fixed;color:var(--cc)}#card.an,#card>.an{transition:top .2s ease-in-out}.in{text-align:left}.ca-con{width:80%;max-width:300px;padding-top:50px}.cR{margin-bottom:50px}#card .act{position:fixed;right:23px;top:100%;font-size:20px;font-weight:100;transform:scaleX(1.3)}');
stynj(':root{--c:#1d95db}.in{justify-content:space-between;height:50px;align-items:center;background:rgba(0,0,0,.56);padding:0 0 0 15px;border-radius:15px;min-width:300px;font-size:14px}.in.disabled{color:grey}.in>label{font-weight:700}.igroup>.in{margin-top:0;border-radius:0;border-bottom:1px solid hsla(0,0%,100%,.30196078431372547)}.igroup>.in:first-child{border-radius:15px 15px 0 0;margin-top:20px}.igroup>.in:last-child{border-radius:0 0 15px 15px;margin-bottom:20px;border-bottom:none}.in-r{background:linear-gradient(90deg,var(--c) 0,var(--c) 50%,#606060 0,#606060);border-radius:8px;height:7px;width:75%;border-radius:15px;height:6px;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:100%;outline:none}.in-r::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:#fff;box-shadow:#000;border-radius:50%;cursor:pointer}.in>input:not([type=checkbox]),.in>select{flex-grow:1;padding:10px 27px 10px 0;background:transparent;border:none;color:#db8b1d;-moz-text-align-last:right;text-align-last:right;-webkit-appearance:none;-moz-appearance:none;text-align:right}.in>select+span{left:-10px;transform:scale(1.6,.9) translateY(-1px);font-weight:200;color:#db8b1d}.in>span{color:#5f5f5f;position:relative;font-size:12px;pointer-events:none;margin-left:-20px;left:-5px}.in>select{margin-inline:12px}.in:focus-within{box-shadow:inset -1px 0 rgba(219,139,29,.627)}.in>input:is([type=checkbox]){margin-right:15px}.in>input:disabled{color:grey}input::-webkit-inner-spin-button,input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}[type=checkbox]{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:51px;height:31px;border-radius:50px;background-color:rgba(148,148,154,.2)!important}[type=checkbox]:after{content:"";width:50%;border-radius:100%;height:80%;display:block;position:relative;background-color:#fff;top:12%;left:3%;transition:all .2s ease-in-out}[type=checkbox].on{background-color:#34c759!important}[type=checkbox].on:after{left:45%}');
const pa={[1]:"text",[2]:"checkbox",[0]:"number",[3]:"select",[4]:"password",[5]:"range"},qa=u(function({label:b,type:a,enumOpts:d,placeholder:e,value:m,unit:r,embed:v=!0,prevDefault:t=!1,min:x,max:n}){let p=m,k,z=[];const g=l=>{function c(q){""===q&&(q=void 0);p=q;z.forEach(y=>y(p))}l.innerHTML="";v&&C(l,"in");var f=J("label");f.innerText=b;Q.call(l,f);3===a?(k=J("select"),C(l,"in-s"),d.forEach(q=>{const y=J("option");y.value=q.v;y.innerText=q.l;Q.call(k,y)}),k.onchange=q=>{t&&q.preventDefault();
c(d[k.options.selectedIndex].v)}):(k=J("input"),k.type=pa[a],k.placeholder=e||"xxxxx",null!=x&&(k.min=`${x}`),null!=n&&(k.max=`${n}`),5===a&&C(k,"in-r"),2===a?((k.checked=m)&&C(k,"on"),k.onchange=q=>{t&&q.preventDefault();B.toggle.call(k.classList,"on");c(k.checked)}):k.onchange=q=>{t&&q.preventDefault();c(k.value)});null!=m&&(k.value=m);k.id=f.htmlFor=`in-${b.split(" ").join("-")}`;Q.call(l,k);if(3===a||r)f=J("span"),f.innerText=r?r:"v",Q.call(l,f)};this.init=l=>{g(l);return{onChange:c=>{z.push(c)},
setDisabled:c=>{B.toggle.call(l.classList,"disabled");k.disabled=c},destroy:()=>{z=[]},reset:()=>{g(l)},isDirty:()=>m!==p,setValue:c=>{p=c;k.value=p}}};return'<div class="fR"></div>'}),ra=["Speed","Acceleration"],sa=[[1,5E3],[1,4294967294]],ta=u(function({pos:b,accel:a,speed:d,...e}){let m=[],r=!1,v=0,t=0,x=!1,n={},p=[];this.init=k=>{function z(h){null==h&&(h=!1);h!==x&&(h?C(k,"an"):D(k,"an"),h?C(l,"an"):D(l,"an"),x=h)}const g=O(".ca-con",k),l=O(".act",k);z(!0);U("card data: ",e);const c=h=>{m.forEach(w=>
w(h))},f=h=>{const w=0===h?d:a,G=qa({type:5,label:ra[h],value:w,embed:!1,min:sa[h][0],max:sa[h][1]}),L=O("input",G.node);D(G.node,"fR");C(G.node,"cR");const H=parseInt,M=H(L.min),P=H(L.max);L.oninput=()=>{const T=H(L.value);X(L,T,M,P,"#1d95db","#606060")};G.onChange(T=>{0===h?c({...e,speed:T}):1===h&&c({...e,accel:T})});Q.call(g,G.node);X(L,w,M,P,"#1d95db","#606060");p.push(G)};f(0);f(1);const q=oa({value:b});q.onChange(h=>{c({...e,tPos:h})});Q.call(g,q.node);const y=()=>{z(!0);k.ontransitionend=
A;const h=k.clientHeight;k.style.top=`${h}px`;l.style.top=`${h+12}px`};l.onclick=y;const A=()=>{m=[];q.destroy();p.forEach(h=>h.destroy());p=[];k.remove()},F=h=>{let {x:w,y:G}=h;null==w&&(w=h.touches[0].clientX,G=h.touches[0].clientY);return{x:w,y:G}};k.onmousedown=k.ontouchstart=h=>{n=h=F(h);t=h.y;r=!0;z(!1)};k.onmouseup=k.onmouseout=k.ontouchend=()=>{if(r){r=!1;z(!0);if(v>k.clientHeight/2)return y();k.style.top="8px";l.style.top="20px";v=t=8}};k.onmousemove=k.ontouchmove=h=>{h=F(h);r&&(8>h.y-t?
n=h:(v+=h.y-n.y,n=h,k.style.top=`${v}px`,l.style.top=`${v+12}px`))};return{destroy:A,onChange:h=>{m.push(h)},show:()=>{k.style.top="8px";l.style.top="20px"}}};return'<div id="card" class="an f flex"><div class="ca-con flex fC"></div><div class="act">X</div></div>'});stynj(":root{--wid:min(calc(33.3vw - 20px),110px,110px)}.tile{background:rgba(0,0,0,.3);border-radius:12px;display:flex}.tile.sq{width:var(--wid);height:var(--wid);margin:5px 0;position:relative}.tile.sq>span{width:calc(var(--wid) - 1px);max-height:90px;top:10px;position:absolute;right:0;border-right:1px groove #fff}.tile.sq p{font-size:12px;margin:auto 21px 10px 9px;font-weight:500;overflow-wrap:anywhere}");
const ua=u(function({name:b,id:a,...d}){let e=[];this.init=m=>{m.id=a;m.onclick=()=>{e.forEach(r=>r({id:a,name:b,...d}))};O("p",m).innerText=b;return{onClick:r=>{e.push(r)},destroy:()=>{e=[]}}};return'<div class="tile sq"><span></span><p>Bedroom Left</p></div>'});stynj(':root{--bord:1px solid rgba(0,0,0,0.034)}#pas{border-radius:7px;justify-content:center;max-width:400px;border:transparent;background:rgba(118,118,128,.24);margin:auto}#pas>div{padding:2px 0;flex-grow:1;text-align:center;font-size:14px;border:1px transparent}#pas>div.sel{background-color:rgba(103,103,105,.64);border-radius:7px;border:1px solid rgba(0,0,0,.14)}#pas>div:after{height:13px;content:"";display:block;position:absolute;border-left:1px solid rgba(142,142,147,.45);border-radius:.5px;transform:translate(-1px,-110%)}#pas>div:first-child:after{border-left:none}');
const va=u(function({items:b,queries:a}){let d=0,e=[],m=[];this.init=r=>{const v=()=>{if(!(1>a.length)){a:{var n=location.search;n=n.substring(1).split("&");for(let p=0;p<n.length;p++){const k=n[p].split("=");if("tab"==k[0]){n=k[1];break a}}n=!1}n=n&&n.toLowerCase();n=a.indexOf(n);U("handleQueryChange: ",n);0>n&&(n=0);d!==n&&x(n)}},t=ja(v),x=n=>{D(m[d],"sel");d=n;C(m[d],"sel");e.map(p=>p(n))};b.map((n,p)=>{const k=K();k.innerText=n;p===d&&C(k,"sel");k.onclick=()=>{a[p]&&V(void 0,{tab:a[p]});x(p)};
m.push(k);Q.call(r,k)});v();return{destroy:()=>{t();e=[];d=0;m=[]},index:()=>d,onChange:n=>{e.push(n)},setIndex:n=>{a[n]&&V(void 0,{tab:a[n]});x(n)}}};return'<div id="pas" class="fw flex fR"></div>'});stynj(".toast{background-color:rgba(0,0,0,.44);box-shadow:1px 1px 8px rgba(84,84,84,.451);border-radius:10px;font-size:13px;margin:10px;height:60px;display:flex;min-width:250px;max-width:500px;position:relative;transition:bottom .5s ease-in-out;pointer-events:all;align-self:center}.tom{margin:auto}");
const wa=u(function({message:b,id:a}){let d=[];this.init=e=>{e.onclick=()=>{d.forEach(m=>m({id:a}))};O("p",e).innerText=b;return{onClick:m=>{d.push(m)},destroy:()=>{d=[]}}};return'<div class="toast"><p class="tom"></p></div>'});stynj(".tc{display:flex;position:absolute;top:0;flex-flow:column-reverse;pointer-events:none;height:calc(100% - 50px);padding-bottom:50px}");
const xa=u(function(){let b=0,a=[];this.init=d=>({destroy:()=>{a.map(e=>e.destroy());a=[];b=0},pushToast:(e,m,r,v)=>{m&&console.error(e);const t=()=>{n.node.style.bottom=`-${50+200*(a.length+1)}px`},x=()=>{t();setTimeout(()=>{n.node.remove()},500)},n=wa({message:e,isError:m,id:b++});t();n.onClick(x);a.push(n);Q.call(d,n.node);setTimeout(()=>{n.node.style.bottom="0px";!r&&setTimeout(x,v||m?5E3:2500)})}});return'<div id="toc" class="fw tc"></div>'}),ya={gen:{deviceName:"WBlinds",mdnsName:"WBlinds",
emitSync:!1},hw:{pStep:19,pDir:18,pEn:13,pSleep:21,pReset:3,pMs1:1,pMs2:5,pMs3:17,pHome:4,cLen:1650,cDia:.1,axDia:15,stepsPerRev:200,res:16},mqtt:{enabled:!1,host:"192.168.0.99",port:1833,topic:"wblinds",user:"user"}},za={state:{pos:0,tPos:0,accel:0,speed:0},settings:S({},ya),pendingState:S({},ya),devices:{},presets:{}};
class Aa{constructor(){this._observers={};this._state=S({},za);const b={};Object.keys(this._state).map(a=>{b[a]=!1});this._loadedKeys={...b};this._savingKeys={...b}}get(b){b=b.split(".");let a=this._state;for(;0<b.length;){if("object"!==typeof a)return;a=a[b.shift()]}return a}set(b,a){b=b.split(".");const d=b.pop();let e=this._state;for(;0<b.length;){if("object"!==typeof e)return;e=e[b.shift()]}e[d]=a}isLoaded(b){return this._loadedKeys[b]}setSaving(b,a){this._savingKeys[b]=a}isSaving(b){return this._savingKeys[b]}update(b,
a){this._observers[b]=this._observers[b]||[];const d=this._state[b];this._state[b]=S({},d,ha(a));this._loadedKeys[b]=!0;this._observers[b].forEach(e=>{e&&e({value:{...a},prev:d})})}observe(b,a){this._observers[b]=this._observers[b]||[];const d=this._observers[b].push(a)-1;this._loadedKeys[b]&&a({value:S({},this._state[b]),prev:void 0});return()=>{delete this._observers[b][d]}}}const Y=new Aa;stynj(".dt{justify-content:space-between}.pt>.sq{height:50px;width:auto;min-width:150px}.pt>.sq>span{display:none}#hlc>h2{-webkit-margin-after:.1em;margin-block-end:.1em;-webkit-margin-before:.5em;margin-block-start:.5em;font-size:16px;padding-left:5px}");
const Ba=u(function(){let b=!0,a=[],d=[],e,m=[];this.init=()=>{const r=()=>{if(b){var p=N("hl"),k=N("hlc");p.style.display="none";D(k,"hide");b=!1}},v=p=>{p=N(`${p}-tiles`);return{container:p,tiles:p.querySelectorAll("div")}},t=p=>{const {container:k,tiles:z}=v(p);p=Math.floor(k.clientWidth/110);let g=z.length;for(;0!==g%p;){const l=K();C(l,"tile","sq","em");Q.call(k,l);g++}},x=(p,k)=>{"device"===p&&d.forEach(z=>z(k))},n=(p,k)=>{const {container:z,tiles:g}=v(p);let l=!1;g.forEach(c=>{const {id:f}=
c;f in k?k[f]=void 0:f===e?l=!0:c.remove()});for(const [c,f]of Object.entries(k)){if(!f||c===e&&l)continue;const q=ua({id:`tile-${c}`,name:f.name||c,...f});q.onClick(y=>x(p,y));a.push(q);Q.call(z,q.node)}t(p)};aa(()=>{let p=Y.observe("presets",({value:k,prev:z})=>{U("presets updated: ",k,z);r();n("preset",k)});m.push(p);p=Y.observe("state",({value:k,prev:z})=>{U("state updated: ",k,z);e=Y.get("settings.gen.deviceName");console.log("_currentDeviceName:",e);r();z=Y.get("settings.gen");const g=Y.get("state");
U("set tile: ",z.deviceName,{...z,...k,...g});n("device",{[z.deviceName]:{...z,...k,...g}})});m.push(p);p=Y.observe("devices",({value:k,prev:z})=>{U("devices updated: ",k,z);r();n("device",k)});m.push(p)});return{onDeviceClick:p=>{d.push(p)},destroy:()=>{m.forEach(p=>p());m=[];d=[];a.forEach(p=>p.destroy());a=[]}}};return'<div id="h" class="f flex"><div id="hl" class="loader"></div><div id="hlc" class="hide fw" style="text-align: left;"><h1 id="ht">WBlinds</h1>\x3c!-- <h4 class="hst">Presets</h4> --\x3e<div id="preset-tiles" class="pt fw flex wrap"></div><h2 class="hst">Devices</h2><div id="device-tiles" class="dt fw flex wrap"></div></div></div>'});
stynj("#stcc{display:flex}#stcc>span{margin:auto}#stcc>span:last-child{margin-bottom:70px}#stcc>div{justify-content:center}#slc-act{position:fixed;bottom:55px;justify-content:space-evenly;left:0}");stynj(".calib-btn{margin-top:40px}#calib-c,#calib-x{position:fixed;left:100%;transition:left .4s ease-in-out;top:0}#calib-c{background:url(bg-0.0.1.jpg),#000;background-position:50%;background-size:cover;overflow:hidden}#calib-c>div{width:100vw;height:100vh}#calib-c>div>h2{margin:80px 30px 10px}#calib-c>div>p{font-size:13px;margin:5px 30px 10px}#calib-x{margin:10px;width:90px;transition-delay:0s;transition-duration:.4s}.cal-conc{margin:20px auto;display:flex;flex-wrap:wrap}.cal-conc *>button{margin:10px auto}.step-inc{width:110px;margin:5px 0;text-align:center;padding:5px;min-width:0;height:auto}.step-inc>input{padding:0 10px 0 0!important;width:40%}.step-inc>span{margin-left:0;left:0}.step-inc>label{color:#5f5f5f;font-weight:400}.cal-conc>div{display:flex;flex-direction:column;margin:0 20px;justify-content:space-between}.cal-conc>div>div{display:flex;flex-direction:row;align-items:center}.cal-conc>div>div>.s-pm{width:20px;height:20px;text-align:center}");
const Ca=(b,a,d)=>Z(b,a,d),Z=(b,a,d,e)=>{e=e||0;d=d||{};a=a||"GET";const m=R(d.body)?JSON.stringify(d.body):d.body,r={...(d.headers||{})};m&&(r["content-type"]="application/json");const v=`${"/api"}/${b}`;return fetch(v,{body:m,method:a,headers:r}).then(t=>{U("got res: ",t);if(!t.ok){e+=1;if(8<e||500>t.status){const x=Error(`[${a}] ${v} failed (${t.status})`);x.response=t;throw x;}return fa(5E3*e).then(()=>Z(b,a,d,e))}return"GET"===a?t.json():void 0})},Da=[{t:"Find home position",d:"Move to the fully open position then tap 'Done'. \nBe careful not to wind the cord too tight."},
{t:"Find closed position",d:"Move to the fully closed position then tap 'Done'"}],Ea=u(function(){let b,a,d=!1,e=[],m=[],r,v=0;const t=window.wblinds.tc,x=g=>{m.forEach(l=>{l&&l({mac:"-",...g})})},n=()=>{const g=.2*(v+1);r.style.transitionDuration=`${g}s`;b.style.transitionDelay=`${.2*(v-.5)}s`;b.style.transitionDuration="0.2s";r.style.left=`${I.innerWidth}px`;b.style.left=`${I.innerWidth}px`;setTimeout(()=>{v=0;r.style.transitionDuration="0.4s";b.style.transitionDuration="0.4s";b.style.transitionDelay=
"0s";r.innerHTML="";C(r,"hide");d=!1},1E3*g)},p=(g,l,c)=>{var f=J("div");C(f,"fC");var q=J("h2");q.innerText=`${l+1}. ${g.t}`;Q.call(f,q);q=J("p");q.innerText=`${g.d}`;Q.call(f,q);var y=J("div");y.style.height="90%";C(y,"fC");Q.call(f,y);q=J("div");C(q,"fR");Q.call(f,q);const A={div:f,c:y};f=(w,G)=>async()=>{const L=w?"preNext":"preBack";try{A[L]&&await A[L]()}catch(H){t.pushToast(`"[Calib] Error in pre: ${H}"`)}v+=w?1:-1;w&&G?n():r.style.left=`-${I.innerWidth*v}px`};0<l&&(y=J("button"),y.innerText=
"Back",Q.call(q,y),y.onclick=f(!1));const F=J("button"),h=(l=l===c-1)?"Done":"Next";g.o||(F.disabled=!0);A.showNext=w=>{w?(F.innerText="",w=J("div"),C(w,"loader"),Q.call(F,w)):(F.innerText=h,F.disabled=!1)};F.innerText=h;F.onclick=f(!0,l);Q.call(q,F);return A},k=()=>{let g=10;const l=J("div");C(l,"cal-conc");var c=J("div"),f=J("button");f.innerText="speed \u25b2";C(f,"btn-up");Q.call(c,f);f=J("button");f.innerText="speed \u25bc";C(f,"btn-down");Q.call(c,f);Q.call(l,c);c=J("div");f=J("button");f.innerText=
"move \u25b2";f.onclick=()=>{x({moveBy:-g})};Q.call(c,f);const q=qa({label:"by",unit:"steps",type:0,value:10});D(q.node,"fR");C(q.node,"step-inc");q.onChange(h=>{1>h?q.setValue(1):g=h});const y=h=>{if(!h||1!==g){var w=1;h=h?1:0;g>=10+h&&(w*=10);g>=100+h&&(w*=10);g>=1E3+h&&(w*=10);g+=w*(-h||1);q.setValue(g)}};f=J("div");const A=J("div");A.innerText="-";C(A,"s-pm");A.onclick=()=>y(!0);const F=J("div");F.innerText="+";C(F,"s-pm");F.onclick=()=>y();Q.call(f,A);Q.call(f,q.node);Q.call(f,F);Q.call(c,f);
f=J("button");f.innerText="move \u25bc";f.onclick=()=>{x({moveBy:g})};Q.call(c,f);Q.call(l,c);return l},z=()=>{Da.forEach((g,l)=>{const c=p(g,l,Da.length);g=k();Q.call(c.c,g);g=J("button");g.innerText="Ok";Q.call(c.c,g);g.onclick=async()=>{c.showNext(!0);0===l?await Z("calibration/home","POST",void 0):await Z("calibration/closed","POST",void 0);c.showNext()};Q.call(r,c.div)});r.style.width=`${I.innerWidth*Da.length}px`;r.style.left="0";b.style.left="0"};this.init=g=>{r=O("div",g);const l=ba("button",
g);a=l.item(0);b=l.item(1);a.onclick=()=>{d||(d=!0,D(b,"hide"),D(r,"hide"),aa(z))};b.onclick=n;return{destroy:()=>{e=[];m=[];g.remove()},setDisabled:c=>{a.disabled=c},onSave:c=>{e.push(c)},onCalib:c=>{m.push(c)}}};return'<div class="f fC"><button class="calib-btn">Calibrate</button><div id="calib-c" class="hide fR"></div><button id="calib-x" class="btn-t hide">&lt; cancel</button></div>'}),Fa={gen:{ssid:{t:1,l:"SSID",g:0},pass:{t:4,l:"Password",g:0},deviceName:{t:1,l:"Device name",g:0},mdnsName:{t:1,
l:"mDNS Name",g:0},emitSync:{t:2,l:"Emit sync data"}},hw:{axDia:{l:"Axis diameter",g:2,u:"mm"},cDia:{l:"Cord diameter",g:2,u:"mm"},cLen:{l:"Cord length",g:2,u:"mm"},pDir:{l:"Direction pin",g:1},pEn:{l:"Enable pin",g:1},pHome:{l:"Home switch pin",g:1},pMs1:{l:"Microstep pin 1",g:1},pMs2:{l:"Microstep pin 2",g:1},pMs3:{l:"Microstep pin 3",g:1},pReset:{l:"Reset pin",g:1},pSleep:{l:"Sleep pin",g:1},pStep:{l:"Step pin",g:1},stepsPerRev:{l:"Steps/revolution",g:2},res:{t:3,l:"Resolution",g:2,o:[{l:"1",v:1},
{l:"1/2",v:2},{l:"1/4",v:4},{l:"1/8",v:8},{l:"1/16",v:16}]}},mqtt:{enabled:{t:2,l:"Enabled",g:3,cg:!0},host:{t:1,l:"Host",g:3},port:{l:"Port",g:3},topic:{t:1,l:"Topic",g:3},user:{t:1,l:"Username",g:3},pass:{t:4,l:"Password",g:3}}},Ga=u(function(){let b=!0,a=!1,d=!1,e=[],m=[],r=[];const v=[],t=["General","Hardware","MQTT"],x=Object.keys(Fa);let n,p,k,z,g;const l=Ea();this.init=()=>{const f=va({items:t,queries:x}),q=h=>{const w=N("stcc");if(w){var G;0===h?G=n:1===h?G=p:2===h&&(G=k);w.innerHTML="";Q.call(w,
G)}else g=()=>q(h)};f.onChange(q);const y=()=>{U("settings loaded: ",Y._state);if(b||a)if(b||!Y.isSaving("settings")){var h=N("sl"),w=N("slc");h.style.display="none";D(w,"hide");w.prepend(f.node);b=!1;a&&A(!1);h=N("stcc");h||(h=K(),h.id="stcc",Q.call(w,h));n=F(x[0]);Q.call(n,l.node);p=F(x[1]);k=F(x[2]);if(!g)return f.setIndex(f.index());g();g=void 0}};aa(()=>{z=Y.observe("settings",({value:h,prev:w})=>{U("settings updated: ",h,w);y()})});const A=h=>{h!==d&&(a=!1,d=h,l&&l.setDisabled(d),h=N("slc-act"),
d?(N("s-save").onclick=()=>{a=!0;e.map(w=>w())},N("s-can").onclick=()=>{a=!0;m.map(w=>w());y()},D(h,"hide")):C(h,"hide"))},F=h=>{const w=J("span"),G=[],L=(H,M)=>{if(null==H)return Q.call(w,M.node);if(null==G[H]){const P=K();C(P,"igroup");G[H]=[P,[]];Q.call(w,P)}G[H][1].push(M);Q.call(G[H][0],M.node)};for(const H in Fa[h]){const {g:M,cg:P,l:T,t:Ja=0,o:Ka,u:La}=Fa[h][H],Ma=`${"pendingState"}.${h}.${H}`,W=qa({label:T,type:Ja,enumOpts:Ka,value:Y.get(`${"settings"}.${h}.${H}`),unit:La});L(M,W);const Na=
r.push(W);W.onChange(na=>{P&&c(na,W,G[M][0],G[M][1]);v[Na]=W.isDirty();A(0<v.filter(Oa=>!0===Oa).length);Y.set(Ma,na)})}return w};return{destroy:()=>{f.destroy();l.destroy();z&&z();r.forEach(h=>h.destroy());r=[];e=[];m=[]},onCancel:h=>{m.push(h)},onSave:h=>{e.push(h)},onCalib:h=>{l.onCalib(h)}}};const c=(f,q,y,A)=>{f?D(y,"disabled"):C(y,"disabled");A.forEach(F=>{q!==F&&F.setDisabled(!f)})};return'<div id="ps" class="f fC"><div id="sl" class="loader"></div><div id="slc" class="hide fw" style="text-align: left;"><div id="slc-act" class="fR fw hide"><button id="s-can" class="btn-c">Cancel</button> <button id="s-save" class="btn-s">Save</button></div></div></div>'}),
Ha=[4,5,22,24],Ia="pos tPos speed accel deviceName mdnsName emitSyncData pinStep pinDir pinEn pinSleep pinReset pinMs1 pinMs2 pinMs3 pinHomeSw cordLength cordDiameter axisDiameter stepsPerRev resolution mqttEnabled mqttHost mqttPort mqttTopic moveUp moveDown moveStop tick".split(" "),Pa=(b={})=>{let a,d=!1,e=0;const {onMessage:m,onDisconnect:r,onConnect:v,onError:t}=b,x=!!t,n=!!v,p=!!m,k=!!r,z=()=>{a=new WebSocket(`ws://${location.hostname}/ws`);a.onopen=g=>{U("[ws] onOpen(): ",g);d=!0;e=0;n&&v(g,
e)};a.onclose=g=>{U("[ws] onClose(): ",g);d=!1;k&&r(g,e);setTimeout(z,Math.min(5E3*++e,6E4))};a.onmessage=g=>{U("[ws] onMessage(): ",g,g.data);console.log("[ws] onMessage(): ",g,g.data);g=g.data;U("unpackMessages: ",g);g.endsWith("/")&&(g=g.substr(0,g.length-1));var l=g.split("/");g=l.shift();parseInt(l.shift());const c=parseInt(l.shift());c.toString(2).split("1").length-1!==l.length&&x&&t("Event flags and data don't match",0);const f={},q={};let y=1;for(let A=0,F=Ia.length;A<F&&0<l.length;A++){if(y&
c){const h=Ia[A],w=l.shift();4>A?f[h]=parseInt(w):q[h]=A in Ha?w:parseInt(w)}y<<=1}l=[];0<Object.keys(f).length&&l.push({type:0,mac:g,data:f});0<Object.keys(q).length&&l.push({type:1,mac:g,data:q});console.log("[ws] onMessage() unpacked: ",l);p&&l.forEach(m)};a.onerror=g=>{U("[ws] onError(): ",g);d=!1;x&&t(g,e)}};z();return{ws:a,push:(g,l)=>{U("[ws] push(): ",g,l);if(d){var c=l.mac;l=0===g?[l.pos,l.tPos,l.speed,l.accel]:2===g?[l.moveBy,l.stop]:[];a:{switch(g){case 0:var f=[],q="";for(var y in l){var A=
l[y];null!=A?(q+=`${A}/`,f.push(1)):f.push(0)}U("[packMessage] f: ",f);l=parseInt(f.reverse().join(""),2);g=`${c}/${g}/${l}/${q}`;break a;case 2:f=[];console.log("data: ",l);y="";for(q in l)A=l[q],null!=A?(y+=`${A}/`,f.push(1)):f.push(0);U("[packMessage] f2: ",f);l=parseInt(f.reverse().join(""),2);g=`${c}/${g}/${l}/${y}`;break a;default:x?t("Unexpected event type",0):console.error("Unexpected event type")}g=void 0}U("[ws] push() str: ",g);a.send(g)}}}},Qa=b=>{const a=document.createElementNS("http://www.w3.org/2000/svg",
"svg"),d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("fill","currentColor");d.setAttribute("d",b.data);a.setAttribute("viewBox",b.box);Q.call(a,d);a.style.width=`${b.w}px`;return a},Ra=Qa({data:"M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z",
box:"0 0 576 512",w:22}),Sa=Qa({data:"M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z",box:"0 0 512 512",w:20}),Ta=Qa({data:"M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7V75c-22.2 7.9-42.8 19.8-60.8 35.1L88.7 85.5c-4.9-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14L67.3 221c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c22.2-7.9 42.8-19.8 60.8-35.1l42.6 24.6c4.9 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z",
box:"0 0 512 512",w:20});stynj(".ic-w{width:22px}.ic{height:16px;width:16px}.ic-home{background:url(home.svg)}#bg{background-image:url(bg-0.0.1.jpg),linear-gradient(40deg,#1d0143,#293b7c,#300a52)}#bg>#_fr{display:none}.overlay{position:fixed;height:100%;width:100%;top:0;left:0;background-color:#333;font-size:24px;display:flex;align-items:center;justify-content:center;z-index:11;opacity:.95;transition:.7s;pointer-events:none}button{width:110px;height:45px;font-size:11px;text-transform:uppercase;letter-spacing:2.5px;margin:20px auto;font-weight:500;color:#000;background:rgba(240,248,255,.8);border:1px solid rgba(202,218,232,.2);border-radius:45px;box-shadow:0 8px 15px rgb(0 0 0/10%);transition:all .3s ease 0s;cursor:pointer;outline:none;position:relative}button.btn-t{border:none;background:none;color:#fff}button:active:not(:disabled,.btn-t){background-color:#2a637a;box-shadow:0 15px 20px rgba(42,99,122,.44313725490196076);color:#fff}button:active.btn-s{background-color:#2ee59d;box-shadow:0 15px 20px rgba(46,229,156,.44313725490196076)}button:active.btn-c{background:#ff5656;box-shadow:0 15px 20px rgba(255,86,86,.4)}@media (hover:hover) and (pointer:fine){button:hover:not(:disabled,.btn-t){transform:translateY(-7px);background-color:#2a637a;box-shadow:0 15px 20px rgba(42,99,122,.44313725490196076);color:#fff}button:hover.btn-s{background-color:#2ee59d;box-shadow:0 15px 20px rgba(46,229,156,.44313725490196076)}button:hover.btn-c{background:#ff5656;box-shadow:0 15px 20px rgba(255,86,86,.4)}}button:disabled{opacity:.5}button>div.loader{transform:translate3d(0,-17px,0);font-size:7px}#app{flex-direction:column;padding:23px 23px 0;height:calc(100% - 73px);overflow-y:scroll}#app,ul{display:flex}ul{list-style-type:none;-webkit-margin-before:0;margin-block-start:0;-webkit-margin-after:0;margin-block-end:0;-webkit-padding-start:0;padding-inline-start:0}li{display:list-item;text-align:-webkit-match-parent;color:hsla(0,0%,100%,.44)}li.s{color:#db8b1d}");
const Ua=[{t:"Home",i:Ra},{t:"Routines",i:Sa},{t:"Settings",i:Ta}];
var run=b=>{function a(){U("saveSettings: ",Y._state);Y.setSaving("settings",!0);U("State._state.settings: ",Y._state.settings);U("State._state.pendingState: ",Y._state.pendingState);const c=ea(Y._state.settings,Y._state.pendingState);U("diffed: ",c);Ca("settings","PUT",{body:c}).then(()=>{Y.setSaving("settings",!1);var f=Y.update,q=Y._state.pendingState;q?.gen?.pass&&(q.gen.pass=void 0);q?.mqtt?.pass&&(q.mqtt.pass=void 0);f.call(Y,"settings",q);k.pushToast("Settings saved")}).catch(f=>{k.pushToast("Failed to save settings");
throw f;})}function d(){U("cancelSettings: ",Y._state);Y.update("pendingState",Y._state.settings)}function e(c){c=ta(c);Q.call(t,c.node);c.onChange(f=>{z.push(0,f)});setTimeout(c.show)}function m(c){console.log("handleCalibrationEvent: ",2,c);z.push(2,c)}function r(c,f,q=[]){f=f||[c];return Z(c,void 0,void 0).then(y=>{f.forEach(A=>Y.update(A,y));q.forEach(A=>Y.set(A,y));return y}).catch(v)}function v(c){c=R(c)?(c?.message||"Error encountered, check console")+"\n"+c.stack:c;k.pushToast(c,!0)}console.log("onLoad(): ",
b);N("favicon").href="favicon.ico";const t=O("body"),x=N("app");let n=-1,p;b.state=Y;const k=xa();b.tc=k;Q.call(t,k.node);I.onerror=v;I.onpopstate=()=>{l(location.pathname);{const c=location.search;U("q === query: ",c,la,location.search);c!==la&&(la=c,ka())}};const z=Pa({onMessage(c){U("WS msg: ",c);1===c.type&&Y.update("settings",{...Y.get("settings"),...c.data});0===c.type&&Y.update("state",{...Y.get("state"),...c.data})},onError(c,f){f||k.pushToast("Websocket disconnected!",!0,!1,5E3)},onConnect(c,
f){U("WS connect: ",c);f&&k.pushToast("Websocket connected!")},onDisconnect(c){U("WS disconnect: ",c)}}),g=ma({labels:Ua});da(N("nav"),g.node);g.onClick(function(c){if(n!==c){var f=0<c?`/${Ua[c].t.toLowerCase()}`:"/";n=c;p?.destroy?.();p?.node.remove();switch(c){case 0:c=Ba();V(f,void 0,!0);c.onDeviceClick(e);p=c;break;case 1:V(f,void 0,!0);p=null;break;case 2:c=Ga(),V(f,void 0,!1),c.onSave(a),c.onCancel(d),c.onCalib(m),p=c,Y.isLoaded("settings")||r("settings",["pendingState","settings"])}p&&Q.call(x,
p.node)}});const l=c=>{c=Ua.map(f=>f.t.toLowerCase()).indexOf(c.substr(1));0>c&&(c=0);g.setIndex(c)};l(location.pathname)};export{run,Y as s}
